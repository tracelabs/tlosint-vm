name: Releases

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build OVA/VMware
        shell: bash
        run: |
          set -euo pipefail

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends debos p7zip qemu-utils zerofree
          sudo rm -rf /var/lib/apt/lists/*

          docker build -t tlvm-builder .

          # Read-only source mount; writable output mount
          docker run --rm \
            --device /dev/kvm \
            --group-add "$(stat -c '%g' /dev/kvm)" \
            -v "$(pwd):/recipes:ro" \
            -v "$(pwd)/images:/images:rw" \
            -w /recipes \
            tlvm-builder ./build.sh -v virtualbox -f ova

          docker run --rm \
            --device /dev/kvm \
            --group-add "$(stat -c '%g' /dev/kvm)" \
            -v "$(pwd):/recipes:ro" \
            -v "$(pwd)/images:/images:rw" \
            -w /recipes \
            tlvm-builder ./build.sh -v vmware -f vmware

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: images
          path: images/*

  release:
    needs: build
    runs-on: ubuntu-24.04
    environment: release
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: images
          path: images

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            images/*.*
            scripts/tlosint-tools.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}